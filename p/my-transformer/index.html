<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Intro æœ€è¿‘åœ¨å­¦ä¹ æ·±åº¦å­¦ä¹ çš„åŸºç¡€çŸ¥è¯†, å¯¹äºäº”èŠ±å…«é—¨çš„æ¨¡å‹æ·±æ„Ÿç¥å¥‡, å¤§å—éœ‡æ’¼, ä½†æ˜¯è§‰å¾—å®æ“èƒ½åŠ›æ¬ ä½³, äºæ˜¯å°è¯•å®æ“æ‰‹æ“ä¸€ä¸ª Transformer\nè®­ç»ƒä¸€ä¸ªæ¨¡å‹æœ‰å››ä¸ªæ­¥éª¤: æ•°æ®å¤„ç† -> å®šä¹‰æ¨¡å‹ -> å®šä¹‰æŸå¤±å‡½æ•° -> ä¼˜åŒ–, æˆ‘ä»¬è¿™æ¬¡ä¹Ÿå°†æŒ‰ç…§è¿™ä¸ªæ­¥éª¤è¿›è¡Œ, è¿‡ç¨‹å‚è€ƒ b ç«™è§†é¢‘ Pytorchæ‰‹æ“ Transformer\n"><title>My Transformer</title>
<link rel=canonical href=https://tok1024.com/p/my-transformer/><link rel=stylesheet href=/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css><meta property='og:title' content="My Transformer"><meta property='og:description' content="Intro æœ€è¿‘åœ¨å­¦ä¹ æ·±åº¦å­¦ä¹ çš„åŸºç¡€çŸ¥è¯†, å¯¹äºäº”èŠ±å…«é—¨çš„æ¨¡å‹æ·±æ„Ÿç¥å¥‡, å¤§å—éœ‡æ’¼, ä½†æ˜¯è§‰å¾—å®æ“èƒ½åŠ›æ¬ ä½³, äºæ˜¯å°è¯•å®æ“æ‰‹æ“ä¸€ä¸ª Transformer\nè®­ç»ƒä¸€ä¸ªæ¨¡å‹æœ‰å››ä¸ªæ­¥éª¤: æ•°æ®å¤„ç† -> å®šä¹‰æ¨¡å‹ -> å®šä¹‰æŸå¤±å‡½æ•° -> ä¼˜åŒ–, æˆ‘ä»¬è¿™æ¬¡ä¹Ÿå°†æŒ‰ç…§è¿™ä¸ªæ­¥éª¤è¿›è¡Œ, è¿‡ç¨‹å‚è€ƒ b ç«™è§†é¢‘ Pytorchæ‰‹æ“ Transformer\n"><meta property='og:url' content='https://tok1024.com/p/my-transformer/'><meta property='og:site_name' content='Toki çš„ä¸ªäººåšå®¢'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='æ·±åº¦å­¦ä¹ '><meta property='article:tag' content='Transformer'><meta property='article:tag' content='Self-Attention'><meta property='article:tag' content='AI'><meta property='article:tag' content='Pytorch'><meta property='article:published_time' content='2025-03-15T11:31:55+08:00'><meta property='article:modified_time' content='2025-03-15T11:31:55+08:00'><meta property='og:image' content='https://tok1024.com/img/touxiang.png'><meta name=twitter:title content="My Transformer"><meta name=twitter:description content="Intro æœ€è¿‘åœ¨å­¦ä¹ æ·±åº¦å­¦ä¹ çš„åŸºç¡€çŸ¥è¯†, å¯¹äºäº”èŠ±å…«é—¨çš„æ¨¡å‹æ·±æ„Ÿç¥å¥‡, å¤§å—éœ‡æ’¼, ä½†æ˜¯è§‰å¾—å®æ“èƒ½åŠ›æ¬ ä½³, äºæ˜¯å°è¯•å®æ“æ‰‹æ“ä¸€ä¸ª Transformer\nè®­ç»ƒä¸€ä¸ªæ¨¡å‹æœ‰å››ä¸ªæ­¥éª¤: æ•°æ®å¤„ç† -> å®šä¹‰æ¨¡å‹ -> å®šä¹‰æŸå¤±å‡½æ•° -> ä¼˜åŒ–, æˆ‘ä»¬è¿™æ¬¡ä¹Ÿå°†æŒ‰ç…§è¿™ä¸ªæ­¥éª¤è¿›è¡Œ, è¿‡ç¨‹å‚è€ƒ b ç«™è§†é¢‘ Pytorchæ‰‹æ“ Transformer\n"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://tok1024.com/img/touxiang.png'><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ¢èœå•>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/touxiang_hu_53488b6e80723a9f.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>âœ¨</span></figure><div class=site-meta><h1 class=site-name><a href=/>Toki çš„ä¸ªäººåšå®¢</a></h1><h2 class=site-description>æ¬¢è¿æ¥åˆ°æˆ‘çš„ç½‘ç«™ğŸ¥³</h2></div></header><ol class=menu-social><li><a href=https://space.bilibili.com/28881018 target=_blank title=Bilibili rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-bilibili"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 10a4 4 0 014-4h10a4 4 0 014 4v6a4 4 0 01-4 4H7a4 4 0 01-4-4v-6z"/><path d="M8 3l2 3"/><path d="M16 3l-2 3"/><path d="M9 13v-2"/><path d="M15 11v2"/></svg></a></li><li><a href=https://github.com/Tok1024 target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>æš—è‰²æ¨¡å¼</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">ç›®å½•</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#intro>Intro</a><ol><li><a href=#transformer>Transformer</a></li></ol></li><li><a href=#æ•°æ®å¤„ç†>æ•°æ®å¤„ç†</a><ol><li><a href=#token-åŒ–>Token åŒ–</a></li><li><a href=#æ•°æ®åˆ†ç»„>æ•°æ®åˆ†ç»„</a><ol><li><a href=#get_batch><code>get_batch</code></a></li></ol></li><li><a href=#è¯åµŒå…¥>è¯åµŒå…¥</a></li><li><a href=#ä½ç½®åµŒå…¥>ä½ç½®åµŒå…¥</a></li></ol></li><li><a href=#æ¨¡å‹æ„å»º>æ¨¡å‹æ„å»º</a><ol><li><a href=#åŸºç¡€æ¨¡å‹>åŸºç¡€æ¨¡å‹</a></li><li><a href=#çŸ©é˜µå˜æ¢>çŸ©é˜µå˜æ¢</a></li><li><a href=#æ©ç çŸ©é˜µ>æ©ç çŸ©é˜µ</a></li><li><a href=#å¤šå¤´æ³¨æ„åŠ›>å¤šå¤´æ³¨æ„åŠ›</a></li><li><a href=#æ®‹å·®è¿æ¥>æ®‹å·®è¿æ¥</a><ol><li><a href=#residual-connection>Residual connection:</a></li><li><a href=#layer-norm>Layer Norm:</a></li><li><a href=#block>Block</a></li></ol></li><li><a href=#å¤šçº§æ®‹å·®ç½‘ç»œ>å¤šçº§æ®‹å·®ç½‘ç»œ</a></li></ol></li><li><a href=#å¤ç›˜>å¤ç›˜</a><ol><li><a href=#æˆæœ>æˆæœ</a></li><li><a href=#é—®é¢˜åˆ†æ>é—®é¢˜åˆ†æ</a></li><li><a href=#æ€»ç»“>æ€»ç»“</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/deeplearning/>DeepLearning
</a><a href=/categories/transformer/>Transformer</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/my-transformer/>My Transformer</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2025-03-15</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>é˜…è¯»æ—¶é•¿: 10 åˆ†é’Ÿ</time></div></footer></div></header><section class=article-content><h2 id=intro>Intro</h2><p>æœ€è¿‘åœ¨å­¦ä¹ æ·±åº¦å­¦ä¹ çš„åŸºç¡€çŸ¥è¯†, å¯¹äºäº”èŠ±å…«é—¨çš„æ¨¡å‹æ·±æ„Ÿç¥å¥‡, å¤§å—éœ‡æ’¼, ä½†æ˜¯è§‰å¾—å®æ“èƒ½åŠ›æ¬ ä½³, äºæ˜¯å°è¯•å®æ“æ‰‹æ“ä¸€ä¸ª Transformer</p><p>è®­ç»ƒä¸€ä¸ªæ¨¡å‹æœ‰å››ä¸ªæ­¥éª¤: æ•°æ®å¤„ç† -> å®šä¹‰æ¨¡å‹ -> å®šä¹‰æŸå¤±å‡½æ•° -> ä¼˜åŒ–, æˆ‘ä»¬è¿™æ¬¡ä¹Ÿå°†æŒ‰ç…§è¿™ä¸ªæ­¥éª¤è¿›è¡Œ, è¿‡ç¨‹å‚è€ƒ b ç«™è§†é¢‘ <a class=link href=https://www.bilibili.com/video/BV1BbFaeVE4W target=_blank rel=noopener>Pytorchæ‰‹æ“ Transformer</a></p><p><img src=/p/my-transformer/images/My%20Transformer-image-1.png width=1501 height=862 srcset="/p/my-transformer/images/My%20Transformer-image-1_hu_1ec8aba735bd98d8.png 480w, /p/my-transformer/images/My%20Transformer-image-1_hu_1b230594cff6ccf6.png 1024w" loading=lazy alt=My-Transformer-image-1 class=gallery-image data-flex-grow=174 data-flex-basis=417px></p><h3 id=transformer>Transformer</h3><p>é¦–å…ˆ, ä»€ä¹ˆæ˜¯ transformer?</p><p><img src=/p/my-transformer/images/My%20Transformer-image-2.png width=537 height=346 srcset="/p/my-transformer/images/My%20Transformer-image-2_hu_a3c07671007e94c3.png 480w, /p/my-transformer/images/My%20Transformer-image-2_hu_81a9e1b46faacbdf.png 1024w" loading=lazy alt=My-Transformer-image-2 class=gallery-image data-flex-grow=155 data-flex-basis=372px></p><p>å½“ç„¶ä¸æ˜¯å˜å½¢é‡‘åˆš, Transformer æ˜¯ä¸€ä¸ªåŸºäº <strong>Self-Attention</strong>æœºåˆ¶çš„ <strong>Seq2seq</strong> çš„æ·±åº¦å­¦ä¹ æ¨¡å‹, èƒ½å¤Ÿæ•æ‰ä¸Šä¸‹æ–‡çš„ä¿¡æ¯å’Œåºåˆ—æ•°æ®, å¯ä»¥å¹¶è¡Œè®­ç»ƒ, ç°åœ¨å·²ç»å¾—åˆ°å¹¿æ³›çš„åº”ç”¨, æˆ‘ä»¬ç†Ÿæ‚‰çš„ BERT, GPT, Deepseek éƒ½ä½¿ç”¨äº† Transformer æ¶æ„, è¶³ä»¥è¯æ˜å…¶æ€§èƒ½çš„ä¼˜è¶Šæ€§</p><p>æˆ‘ä»¬è¿™æ¬¡å°†è®­ç»ƒä¸€ä¸ªéå¸¸ç®€å•çš„ transformer, è¾“å…¥æ•°æ®æ˜¯ä¸Šæ–‡, è®¾å®šä¸€ä¸ªç”Ÿæˆçš„æ–‡æœ¬é•¿åº¦, ç„¶åç›´æ¥è¾“å‡ºä¸‹æ–‡, æœªæ¥å¯èƒ½ä¼šæŠŠèµ·å§‹å’Œç»“æŸæ ‡è¯†ç¼–ç åˆ° embedding å‘é‡ä¸­, ä½†æˆ‘ç°åœ¨è¿˜ä¸ä¼š</p><h2 id=æ•°æ®å¤„ç†>æ•°æ®å¤„ç†</h2><p>æˆ‘ä»¬çš„åŸå§‹æ•°æ®æ˜¯ä¸­æ–‡çš„æ–‡æœ¬æ–‡ä»¶, è¦æƒ³å­˜å‚¨åˆ°è®¡ç®—æœºä¸­ä¾›æ¨¡å‹è®­ç»ƒ, å°±éœ€è¦å…ˆæŠŠæ¯ä¸ªå­—è½¬æ¢ä¸ºä¸€ä¸ª <code>token</code>, å†å°† <code>token</code> ç»è¿‡ Embedding åµŒå…¥ä¸ºè¯å‘é‡</p><p><img src=/p/my-transformer/images/My%20Transformer-image-3.png width=1002 height=525 srcset="/p/my-transformer/images/My%20Transformer-image-3_hu_e542ce639874fbe2.png 480w, /p/my-transformer/images/My%20Transformer-image-3_hu_34e429d4d4e74803.png 1024w" loading=lazy alt=My-Transformer-image-3 class=gallery-image data-flex-grow=190 data-flex-basis=458px></p><h3 id=token-åŒ–>Token åŒ–</h3><p>è¿™ä¸€æ­¥ä¸­, æˆ‘ä»¬éœ€è¦åˆ›å»ºå”¯ä¸€, æœ‰åºçš„å­—ç¬¦é›†, ç„¶åå»ºç«‹æ•°å­—å³ Token åˆ°å­—ç¬¦çš„æ˜ å°„</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># æœ‰åºçš„å­—ç¬¦é›†åˆ</span>
</span></span><span class=line><span class=cl><span class=n>chars</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span><span class=nb>list</span><span class=p>(</span><span class=nb>set</span><span class=p>(</span><span class=n>text</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å­—ç¬¦åˆ°æ•°å­—çš„æ˜ å°„</span>
</span></span><span class=line><span class=cl><span class=n>c2i</span> <span class=o>=</span> <span class=p>{</span><span class=n>c</span><span class=p>:</span><span class=n>i</span> <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>c</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>chars</span><span class=p>)}</span>
</span></span><span class=line><span class=cl><span class=n>i2c</span> <span class=o>=</span> <span class=p>{</span><span class=n>i</span><span class=p>:</span><span class=n>c</span> <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>c</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>chars</span><span class=p>)}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ç¼–ç : å­—ç¬¦ä¸² -&gt; æ•°å­—åˆ—è¡¨</span>
</span></span><span class=line><span class=cl><span class=c1># è§£ç : æ•°å­—åˆ—è¡¨ -&gt; å­—ç¬¦ä¸²</span>
</span></span><span class=line><span class=cl><span class=n>encode</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=p>[</span><span class=n>c2i</span><span class=p>[</span><span class=n>c</span><span class=p>]</span> <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=n>x</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>decode</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=n>i2c</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>x</span><span class=p>])</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=æ•°æ®åˆ†ç»„>æ•°æ®åˆ†ç»„</h3><p>è®­ç»ƒæ¨¡å‹æ—¶, ä¸€æ¡ä¸€æ¡è®­ç»ƒæ•ˆç‡è¿‡äºä½ä¸‹, æˆ‘ä»¬ä¼šé€‰æ‹©ä¸€æ¬¡å¤„ç†ä¸€æ‰¹æ•°æ®, è¿™æ ·å¯ä»¥åˆ©ç”¨ GPU çš„å¹¶è¡Œæ€§, æé«˜æ€§èƒ½, æ¯ä¸€ä¸ªå‘é‡æ˜¯é•¿åº¦ä¸º <code>block_size</code> çš„å­—ç¬¦ä¸²</p><p><img src=/p/my-transformer/images/My%20Transformer-image-4.png width=1190 height=708 srcset="/p/my-transformer/images/My%20Transformer-image-4_hu_3b1257f6461f8a0d.png 480w, /p/my-transformer/images/My%20Transformer-image-4_hu_9bc4518e90917798.png 1024w" loading=lazy alt=My-Transformer-image-4 class=gallery-image data-flex-grow=168 data-flex-basis=403px></p><p>æ‰€ä»¥ä¸€æ‰¹è®­ç»ƒèµ„æ–™æ˜¯ <code>[batch_size, block_size, embedding_dim]</code> çš„ä¸‰é˜¶å¼ é‡</p><h4 id=get_batch><code>get_batch</code></h4><p><img src=/p/my-transformer/images/My%20Transformer-image-5.png width=1465 height=442 srcset="/p/my-transformer/images/My%20Transformer-image-5_hu_3c043398af04e503.png 480w, /p/my-transformer/images/My%20Transformer-image-5_hu_dfb321013003f8bd.png 1024w" loading=lazy alt=My-Transformer-image-5 class=gallery-image data-flex-grow=331 data-flex-basis=795px></p><p>å¯¹äº batch çš„é€‰æ‹©, æˆ‘ä»¬éšæœºåœ¨æ–‡æœ¬ä¸­å–ä¸€æ®µ block</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># TODO: æ•°æ®åˆ†æ‰¹</span>
</span></span><span class=line><span class=cl><span class=c1># 1. åˆ’åˆ†æ•°æ®é›†</span>
</span></span><span class=line><span class=cl><span class=c1># ç›´æ¥å¯¹textè¿›è¡Œç¼–ç </span>
</span></span><span class=line><span class=cl><span class=n>data</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>tensor</span><span class=p>(</span><span class=n>encode</span><span class=p>(</span><span class=n>text</span><span class=p>),</span> <span class=n>dtype</span><span class=o>=</span><span class=n>torch</span><span class=o>.</span><span class=n>long</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>valid_size</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>text</span><span class=p>)</span> <span class=o>*</span> <span class=n>validation_split</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>valid_data</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>valid_size</span><span class=p>:]</span>
</span></span><span class=line><span class=cl><span class=n>train_data</span> <span class=o>=</span> <span class=n>data</span><span class=p>[:</span><span class=n>valid_size</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. get_batchå‡½æ•°</span>
</span></span><span class=line><span class=cl><span class=c1># ä»æ•°æ®é›†ä¸­éšæœºå–å‡ºbatch_sizeä¸ªæ•°æ®</span>
</span></span><span class=line><span class=cl><span class=c1># è¾“å…¥: split - &#34;valid&#34; or &#34;train&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># è¾“å‡º: (batch_size, block_size)çš„tensor</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_batch</span><span class=p>(</span><span class=n>split</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>valid_data</span> <span class=k>if</span> <span class=n>split</span> <span class=o>==</span> <span class=s2>&#34;valid&#34;</span> <span class=k>else</span> <span class=n>train_data</span>
</span></span><span class=line><span class=cl>    <span class=n>idx</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>)</span> <span class=o>-</span> <span class=n>block_size</span><span class=p>,</span> <span class=p>(</span><span class=n>batch_size</span><span class=p>,))</span>
</span></span><span class=line><span class=cl>    <span class=c1># stackå¤„ç†ä¸€ä¸ªåˆ—è¡¨,æŠŠä¸€ä¸ªå¼ é‡çš„åˆ—è¡¨åœ¨æ–°çš„ç»´åº¦ä¸Šå †å èµ·æ¥</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>stack</span><span class=p>([</span><span class=n>data</span><span class=p>[</span><span class=n>i</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=n>block_size</span><span class=p>]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>idx</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>y</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>stack</span><span class=p>([</span><span class=n>data</span><span class=p>[</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=o>+</span><span class=n>block_size</span><span class=p>]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>idx</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=c1># xæ˜¯å­—ç¬¦ä¸²çš„åˆ—è¡¨, yæ˜¯xçš„ä¸‹ä¸€ä¸ªå­—ç¬¦çš„åˆ—è¡¨</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span><span class=p>,</span> <span class=n>y</span> <span class=o>=</span> <span class=n>x</span><span class=o>.</span><span class=n>to</span><span class=p>(</span><span class=n>device</span><span class=p>),</span> <span class=n>y</span><span class=o>.</span><span class=n>to</span><span class=p>(</span><span class=n>device</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>get_batch</span><span class=p>(</span><span class=s2>&#34;train&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œç”¨åˆ°äº† <code>torch.stack</code>, è®©æˆ‘æƒ³èµ·æ¥å¦ä¸€ä¸ªå¸¸ç”¨çš„æ‹¼æ¥ api <code>torch.cat</code>, äºŒè€…æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢?</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># åˆ›å»ºä¸¤ä¸ªç¤ºä¾‹å¼ é‡</span>
</span></span><span class=line><span class=cl><span class=n>a</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>tensor</span><span class=p>([[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>],</span> <span class=p>[</span><span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>]])</span>
</span></span><span class=line><span class=cl><span class=n>b</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>tensor</span><span class=p>([[</span><span class=mi>5</span><span class=p>,</span> <span class=mi>6</span><span class=p>],</span> <span class=p>[</span><span class=mi>7</span><span class=p>,</span> <span class=mi>8</span><span class=p>]])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ä½¿ç”¨ torch.cat è¿›è¡Œæ‹¼æ¥</span>
</span></span><span class=line><span class=cl><span class=n>cat_result</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>cat</span><span class=p>((</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>),</span> <span class=n>dim</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;torch.cat ç»“æœï¼š&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>cat_result</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;å½¢çŠ¶ï¼š&#34;</span><span class=p>,</span> <span class=n>cat_result</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ä½¿ç”¨ torch.stack è¿›è¡Œæ‹¼æ¥</span>
</span></span><span class=line><span class=cl><span class=n>stack_result</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>stack</span><span class=p>((</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>),</span> <span class=n>dim</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>torch.stack ç»“æœï¼š&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>stack_result</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;å½¢çŠ¶ï¼š&#34;</span><span class=p>,</span> <span class=n>stack_result</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>è¾“å‡ºç»“æœ:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>torch.cat ç»“æœï¼š 
</span></span><span class=line><span class=cl>tensor([[1, 2], [3, 4], [5, 6], [7, 8]]) 
</span></span><span class=line><span class=cl>å½¢çŠ¶ï¼š torch.Size([4, 2]) 
</span></span><span class=line><span class=cl>torch.stack ç»“æœï¼š 
</span></span><span class=line><span class=cl>tensor([[[1, 2], [3, 4]], [[5, 6], [7, 8]]]) 
</span></span><span class=line><span class=cl>å½¢çŠ¶ï¼š torch.Size([2, 2, 2])
</span></span></code></pre></td></tr></table></div></div><p>åŸæ¥ stack æ˜¯åœ¨æ–°çš„ç»´åº¦ä¸Šè¿æ¥åŸæœ¬çš„ä¸¤ä¸ªå¼ é‡, è€Œ cat æ˜¯åœ¨å¤–å±‚ç»´åº¦æ‹¼æ¥ä¸¤ä¸ªå¼ é‡</p><h3 id=è¯åµŒå…¥>è¯åµŒå…¥</h3><p>æˆ‘ä»¬å·²ç»æœ‰äº†å­—ç¬¦åˆ°æ•°å­—çš„æ˜ å°„, ä½†æ˜¯ç°åœ¨è¿™ä¸ªæ•°å­—æ²¡ä»€ä¹ˆå«ä¹‰, æ›´æ— æ³•å‚ä¸è¿ç®—, é‚£æˆ‘ä»¬å°±éœ€è¦æŠŠæ¯ä¸ªè¯è¡¨ç¤ºä¸ºä¸€ä¸ªå‘é‡, è¿™å°±ç”¨åˆ°äº† <code>nn.Embedding</code> å­ç±», åˆ›å»ºä¸€ä¸ª <code>embedding_table</code>, ç»´æŠ¤å­—ç¬¦é›†çš„ç´¢å¼•åˆ° Embedding ç©ºé—´çš„æ˜ å°„</p><p><img src=/p/my-transformer/images/My%20Transformer-image-6.png width=1514 height=738 srcset="/p/my-transformer/images/My%20Transformer-image-6_hu_e62424821608eb22.png 480w, /p/my-transformer/images/My%20Transformer-image-6_hu_59c890ba86b662d4.png 1024w" loading=lazy alt=My-Transformer-image-6 class=gallery-image data-flex-grow=205 data-flex-basis=492px></p><p>ä¸€å¼€å§‹æ—¶, åµŒå…¥å‘é‡éšæœºç”Ÿæˆ, ç„¶åä¸æ–­æ¢¯åº¦ä¼˜åŒ–, å¯èƒ½ä¼šå’ŒçœŸå®çš„è¯­ä¹‰æœ‰ä¸€å®šçš„ç›¸å…³æ€§</p><h3 id=ä½ç½®åµŒå…¥>ä½ç½®åµŒå…¥</h3><p>æˆ‘ä»¬çŸ¥é“, åœ¨ä¸€ä¸ªæ–‡æœ¬ä¸­, è¯è¯­å’Œå…¶åœ¨æ–‡æœ¬ä¸­çš„é¡ºåºæ˜¯æœ‰å¾ˆå¼ºçš„å…³ç³»çš„, è¿™å°±éœ€è¦æŠŠä½ç½®ç¼–ç è¯å‘é‡, è¿™é‡Œæˆ‘ä»¬åŒæ ·ç”¨ pytorch æä¾›çš„ embedding ç±»è¿›è¡ŒåµŒå…¥, ä¸åŸæ–‡çš„æ­£ä½™å¼¦ä¸åŒ, åç»­å¯ä»¥è¿›è¡Œè°ƒæ•´</p><p><img src=/p/my-transformer/images/My%20Transformer-image-7.png width=1469 height=631 srcset="/p/my-transformer/images/My%20Transformer-image-7_hu_891943d336c3d25e.png 480w, /p/my-transformer/images/My%20Transformer-image-7_hu_4a31acff8e2c54df.png 1024w" loading=lazy alt=My-Transformer-image-7 class=gallery-image data-flex-grow=232 data-flex-basis=558px></p><p>æœ€åæŠŠè¯åµŒå…¥å’Œä½ç½®åµŒå…¥çš„å‘é‡ç›¸åŠ å¾—åˆ°è¾“å…¥å‘é‡</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># ä½ç½®åµŒå…¥</span>
</span></span><span class=line><span class=cl><span class=n>position_embedding_table</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Embedding</span><span class=p>(</span><span class=n>block_size</span><span class=p>,</span> <span class=n>embedding_dim</span><span class=p>)</span><span class=o>.</span><span class=n>to</span><span class=p>(</span><span class=n>device</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>position_ebd</span> <span class=o>=</span> <span class=n>position_embedding_table</span><span class=p>(</span><span class=n>torch</span><span class=o>.</span><span class=n>arange</span><span class=p>(</span><span class=n>block_size</span><span class=p>)</span><span class=o>.</span><span class=n>to</span><span class=p>(</span><span class=n>device</span><span class=p>))</span><span class=o>.</span><span class=n>unsqueeze</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Â <span class=k>def</span> <span class=nf>forward</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>target</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=n>B</span><span class=p>,</span> <span class=n>T</span> <span class=o>=</span> <span class=n>x</span><span class=o>.</span><span class=n>shape</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=n>ve</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>vocab_embedding</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=n>pe</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>position_embedding</span><span class=p>(</span><span class=n>torch</span><span class=o>.</span><span class=n>arange</span><span class=p>(</span><span class=n>T</span><span class=p>)</span><span class=o>.</span><span class=n>to</span><span class=p>(</span><span class=n>device</span><span class=p>))</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=n>h</span> <span class=o>=</span> <span class=n>ve</span> <span class=o>+</span> <span class=n>pe</span> <span class=c1># (B, T, E)</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=n>h</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>blocks</span><span class=p>(</span><span class=n>h</span><span class=p>)</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=n>h</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ln_f</span><span class=p>(</span><span class=n>h</span><span class=p>)</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=n>logits</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fc</span><span class=p>(</span><span class=n>h</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=æ¨¡å‹æ„å»º>æ¨¡å‹æ„å»º</h2><h3 id=åŸºç¡€æ¨¡å‹>åŸºç¡€æ¨¡å‹</h3><p>æˆ‘ä»¬å…ˆè€ƒè™‘åˆ›å»ºä¸€ä¸ªç®€å•çš„å‚»ç“œæ¨¡å‹</p><p><img src=/p/my-transformer/images/My%20Transformer-image-8.png width=1489 height=693 srcset="/p/my-transformer/images/My%20Transformer-image-8_hu_7e9314b5a868c7e5.png 480w, /p/my-transformer/images/My%20Transformer-image-8_hu_c3fe7e89ead71e13.png 1024w" loading=lazy alt=My-Transformer-image-8 class=gallery-image data-flex-grow=214 data-flex-basis=515px></p><p>æŠŠåµŒå…¥åçš„å¼ é‡è¾“å…¥ç¥ç»ç½‘ç»œ, ä»–ä¼šéšæœºè¾“å‡ºä¸€ä¸ªå¼ é‡, ç»´åº¦æ˜¯ <code>[Batch_size, Block_size, Vocabsize]</code>, å…¶ä¸­æœ€åä¸€ç»´æ˜¯å½’ä¸€åŒ–çš„, ä»£è¡¨äº†ä¸‹æ–‡ä¸­æ¯ä¸ª Token çš„æ¦‚ç‡, ä¸è¿‡è¿™é‡Œæ˜¯éšæœºç”Ÿæˆçš„</p><p><img src=/p/my-transformer/images/My%20Transformer-image-9.png width=847 height=424 srcset="/p/my-transformer/images/My%20Transformer-image-9_hu_c0043729fb7c4895.png 480w, /p/my-transformer/images/My%20Transformer-image-9_hu_f569e8e835b00b9d.png 1024w" loading=lazy alt=My-Transformer-image-9 class=gallery-image data-flex-grow=199 data-flex-basis=479px></p><p>Token ç”Ÿæˆ: ä»æ¦‚ç‡åˆ†å¸ƒä¸­æŠ½æ ·å‡º one-hot å‘é‡, ä½¿ç”¨ <code>torch.multinomial</code></p><p><img src=/p/my-transformer/images/My%20Transformer-image-10.png width=1069 height=381 srcset="/p/my-transformer/images/My%20Transformer-image-10_hu_39c77b0f500511a5.png 480w, /p/my-transformer/images/My%20Transformer-image-10_hu_67cf027f15c0d3de.png 1024w" loading=lazy alt=My-Transformer-image-10 class=gallery-image data-flex-grow=280 data-flex-basis=673px></p><p>å®ç°:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Model</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>LanguageModel</span><span class=p>(</span><span class=n>nn</span><span class=o>.</span><span class=n>Module</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=c1># x: (batch_size, block_size) å•ä½æ˜¯token</span>
</span></span><span class=line><span class=cl>    <span class=c1># target: (batch_size, block_size) å•ä½æ˜¯token</span>
</span></span><span class=line><span class=cl>    <span class=c1># è¿”å›: (batch_size, block_size, vocab_size) logits</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>forward</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>target</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>B</span><span class=p>,</span> <span class=n>T</span> <span class=o>=</span> <span class=n>x</span><span class=o>.</span><span class=n>shape</span>
</span></span><span class=line><span class=cl>        <span class=n>random_tensor</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>rand</span><span class=p>(</span><span class=n>B</span><span class=p>,</span> <span class=n>T</span><span class=p>,</span> <span class=n>vocab_size</span><span class=p>)</span><span class=o>.</span><span class=n>to</span><span class=p>(</span><span class=n>device</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>logits</span> <span class=o>=</span> <span class=n>random_tensor</span> <span class=o>/</span> <span class=n>random_tensor</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=n>dim</span><span class=o>=-</span><span class=mi>1</span><span class=p>,</span> <span class=n>keepdim</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>loss</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>logits</span><span class=p>,</span> <span class=n>loss</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># ç”Ÿæˆ</span>
</span></span><span class=line><span class=cl>    <span class=c1># token_seq: (batch_size, block_size) ä¸Šæ–‡, å•ä½æ˜¯token</span>
</span></span><span class=line><span class=cl>    <span class=c1># max_token: int æœ€å¤§ç”Ÿæˆé•¿åº¦</span>
</span></span><span class=line><span class=cl>    <span class=c1># è¿”å›: (batch_size, max_token) ç”Ÿæˆçš„tokenåºåˆ—</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>generate</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>token_seq</span><span class=p>,</span> <span class=n>max_token</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>max_token</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=c1># å–æœ€åblock_sizeä¸ªtoken</span>
</span></span><span class=line><span class=cl>            <span class=n>token_input</span> <span class=o>=</span> <span class=n>token_seq</span><span class=p>[:,</span> <span class=o>-</span><span class=n>block_size</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>            <span class=c1># è®¡ç®—logits</span>
</span></span><span class=line><span class=cl>            <span class=n>logits</span><span class=p>,</span> <span class=n>loss</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>forward</span><span class=p>(</span><span class=n>token_input</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># å–å­—ç¬¦ä¸²çš„æœ€åä¸€ä¸ªå­—ç¬¦, ç›®å‰è¿˜åªæ˜¯ç½‘ç»œç›´æ¥è¾“å‡ºçš„ç»“æœ</span>
</span></span><span class=line><span class=cl>            <span class=n>logits</span> <span class=o>=</span> <span class=n>logits</span><span class=p>[:,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=p>:]</span>
</span></span><span class=line><span class=cl>            <span class=c1># softmax,ç»´åº¦æ˜¯-1,ä¹Ÿå°±æ˜¯vocabularyçš„ç»´åº¦</span>
</span></span><span class=line><span class=cl>            <span class=n>prob</span> <span class=o>=</span> <span class=n>F</span><span class=o>.</span><span class=n>softmax</span><span class=p>(</span><span class=n>logits</span><span class=p>,</span> <span class=n>dim</span><span class=o>=-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># é‡‡æ ·, è¾“å‡ºæ˜¯ä¸‹ä¸€ä¸ªtoken,å½¢çŠ¶æ˜¯(batch_size, 1)</span>
</span></span><span class=line><span class=cl>            <span class=n>next_token</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>multinomial</span><span class=p>(</span><span class=n>prob</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># æ‹¼æ¥åˆ°token_seqåé¢, åœ¨æ—¶é—´ç»´åº¦ä¸Š</span>
</span></span><span class=line><span class=cl>            <span class=n>token_seq</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>cat</span><span class=p>([</span><span class=n>token_seq</span><span class=p>,</span> <span class=n>next_token</span><span class=p>],</span> <span class=n>dim</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>token_seq</span><span class=p>[:,</span> <span class=o>-</span><span class=n>max_token</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            
</span></span></code></pre></td></tr></table></div></div><h3 id=çŸ©é˜µå˜æ¢>çŸ©é˜µå˜æ¢</h3><p>åœ¨ç¥ç»ç½‘ç»œä¸­, æˆ‘ä»¬ä¸ä¼šç”¨åµŒå…¥å‘é‡æ¥è¿›è¡Œè®¡ç®—, è€Œæ˜¯æŠŠè¯å‘é‡<strong>æŠ•å½±åˆ°ä¸åŒçš„å­ç©ºé—´ä¸­</strong></p><ul><li>Q: æŸ¥è¯¢çŸ©é˜µ, å®šä¹‰äº†è¯¥ Token å¦‚ä½•å»è®¿é—®åˆ«çš„ Token çš„ä¿¡æ¯</li><li>K: é”®çŸ©é˜µ, å®šä¹‰äº†è¯¥ Token ç»™åˆ«çš„çŸ©é˜µæä¾›å“ªäº›ä¿¡æ¯</li><li>V: å€¼çŸ©é˜µ, å®šä¹‰äº†è¯å‘é‡åˆ°æˆ‘ä»¬åˆ›å»ºçš„å­ç©ºé—´çš„æ˜ å°„</li></ul><p>å†çœ‹ä¸‹è®ºæ–‡ä¸­ä¼˜ç¾çš„å…¬å¼</p><p>$Attention(Q,K,V)=softmax(\frac{ QK^T} {d_k}â€‹)V$</p><p>å‡ ä½•æ„ä¹‰ï¼š</p><ul><li><strong>ç‚¹ç§¯</strong>ï¼šåœ¨å­ç©ºé—´Â Rdkâ€‹Â ä¸­ï¼Œè®¡ç®—ä¸¤ä¸ªå‘é‡çš„å¤¹è§’ä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆæœªç¼©æ”¾æ—¶ï¼‰ã€‚</li><li><strong>ç¼©æ”¾å› å­Â dkâ€‹â€‹</strong>ï¼šé˜²æ­¢ç‚¹ç§¯å€¼è¿‡å¤§å¯¼è‡´æ¢¯åº¦æ¶ˆå¤±ã€‚</li><li><strong>softmax</strong>ï¼šå°†ç›¸ä¼¼åº¦è½¬åŒ–ä¸ºæ¦‚ç‡åˆ†å¸ƒï¼Œè¡¨ç¤ºä¸åŒä½ç½®çš„é‡è¦æ€§æƒé‡ã€‚</li></ul><p>è¿™ä¸ªå…¬å¼ç²¾å‡†çš„æè¿°äº† Attention æœºåˆ¶, å³ç”¨ Q å»æŸ¥è¯¢ K, å¯¹å¾—åˆ°çš„çŸ©é˜µé™¤ä»¥ä¸€ä¸ªç¼©æ”¾å› å­(é˜²æ­¢æ¢¯åº¦çˆ†ç‚¸), è¾“å…¥ softmax å¾—åˆ°æ³¨æ„åŠ›çŸ©é˜µ, ç„¶åå’Œ V çŸ©é˜µç›¸ä¹˜å, å¾—åˆ°äº† Token çš„æ¦‚ç‡åˆ†å¸ƒ</p><h3 id=æ©ç çŸ©é˜µ>æ©ç çŸ©é˜µ</h3><p>å®è·µä¸­, æ³¨æ„åŠ›çŸ©é˜µä¸èƒ½å…¨éƒ¨éƒ½æœ‰å€¼, å› ä¸ºä¸€ä¸ªé¢„æµ‹æ¨¡å‹ä¸èƒ½è¾“å…¥æœªæ¥çš„å‘é‡, è¿™æ ·ä¼šç ´åæ¨¡å‹ç»“æ„</p><p>æˆ‘ä»¬ç”¨ä¸‹ä¸‰è§’çŸ©é˜µæ¥è¡¨ç¤º</p><p><img src=/p/my-transformer/images/My%20Transformer-image-11.png width=1476 height=695 srcset="/p/my-transformer/images/My%20Transformer-image-11_hu_63b00df0cc7c60f8.png 480w, /p/my-transformer/images/My%20Transformer-image-11_hu_c807952f50e59537.png 1024w" loading=lazy alt=My-Transformer-image-11 class=gallery-image data-flex-grow=212 data-flex-basis=509px></p><p>æ¯ä¸€ä¸ªå€¼é¢„æµ‹æ—¶, æˆ‘ä»¬åªçœ‹ä¸Šæ–‡, é˜²æ­¢ç­”æ¡ˆæ³„éœ²</p><p><img src=/p/my-transformer/images/My%20Transformer-image-12.png width=1455 height=663 srcset="/p/my-transformer/images/My%20Transformer-image-12_hu_1e4865f1fc10aad8.png 480w, /p/my-transformer/images/My%20Transformer-image-12_hu_fa563062908c6a04.png 1024w" loading=lazy alt=My-Transformer-image-12 class=gallery-image data-flex-grow=219 data-flex-basis=526px></p><p>ä¸å¯è®­ç»ƒçš„çŸ©é˜µ: ä¸‰è§’çŸ©é˜µ, Tril æŠŠå³ä¸Šè§’å–ä¸º 0</p><p>å•å¤´æ³¨æ„åŠ›çš„å®ç°</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Heads</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Head</span><span class=p>(</span><span class=n>nn</span><span class=o>.</span><span class=n>Module</span><span class=p>):</span>
</span></span><span class=line><span class=cl>Â  Â  <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>head_size</span> <span class=o>=</span> <span class=n>head_size</span><span class=p>):</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>()</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=bp>self</span><span class=o>.</span><span class=n>value</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Linear</span><span class=p>(</span><span class=n>embedding_dim</span><span class=p>,</span> <span class=n>head_size</span><span class=p>,</span> <span class=n>bias</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=bp>self</span><span class=o>.</span><span class=n>query</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Linear</span><span class=p>(</span><span class=n>embedding_dim</span><span class=p>,</span> <span class=n>head_size</span><span class=p>,</span> <span class=n>bias</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=bp>self</span><span class=o>.</span><span class=n>key</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Linear</span><span class=p>(</span><span class=n>embedding_dim</span><span class=p>,</span> <span class=n>head_size</span><span class=p>,</span> <span class=n>bias</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=c1># ç”Ÿæˆä¸€ä¸ªä¸å¯è®­ç»ƒçš„ä¸‹ä¸‰è§’çŸ©é˜µ</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=bp>self</span><span class=o>.</span><span class=n>register_buffer</span><span class=p>(</span><span class=s2>&#34;mask&#34;</span><span class=p>,</span> <span class=n>torch</span><span class=o>.</span><span class=n>tril</span><span class=p>(</span><span class=n>torch</span><span class=o>.</span><span class=n>ones</span><span class=p>(</span><span class=n>block_size</span><span class=p>,</span> <span class=n>block_size</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=bp>self</span><span class=o>.</span><span class=n>dropout</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Dropout</span><span class=p>(</span><span class=n>dropout_rate</span><span class=p>)</span>
</span></span><span class=line><span class=cl>Â  Â  <span class=k>def</span> <span class=nf>forward</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>x</span><span class=p>):</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=c1># x: (batch_size, block_size, embedding_dim)</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=c1># return: (batch_size, block_size, head_size)</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=c1># æ¯ä¸ªheadæœ‰ä¸€ä¸ªvalueçŸ©é˜µ, ç”¨äºè®¡ç®—attention</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=n>B</span><span class=p>,</span> <span class=n>T</span><span class=p>,</span> <span class=n>C</span> <span class=o>=</span> <span class=n>x</span><span class=o>.</span><span class=n>shape</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=n>Q</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=n>K</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>key</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=n>attention</span> <span class=o>=</span> <span class=n>Q</span> <span class=o>@</span> <span class=n>K</span><span class=o>.</span><span class=n>transpose</span><span class=p>(</span><span class=o>-</span><span class=mi>2</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=o>*</span> <span class=n>C</span> <span class=o>**</span> <span class=o>-</span><span class=mf>0.5</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=n>attention</span> <span class=o>=</span> <span class=n>attention</span><span class=o>.</span><span class=n>masked_fill</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>mask</span> <span class=o>==</span> <span class=mi>0</span><span class=p>,</span> <span class=nb>float</span><span class=p>(</span><span class=s1>&#39;-inf&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=c1># è¾“å‡ºçš„ç»“æœæ˜¯ valueå‘é‡ * attention</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=n>V</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>value</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=n>attention</span> <span class=o>=</span> <span class=n>F</span><span class=o>.</span><span class=n>softmax</span><span class=p>(</span><span class=n>attention</span><span class=p>,</span> <span class=n>dim</span><span class=o>=-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=n>out</span> <span class=o>=</span> <span class=n>attention</span> <span class=o>@</span> <span class=n>V</span> <span class=c1># (B, T, head_size)</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=k>return</span> Â <span class=bp>self</span><span class=o>.</span><span class=n>dropout</span><span class=p>(</span><span class=n>out</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=å¤šå¤´æ³¨æ„åŠ›>å¤šå¤´æ³¨æ„åŠ›</h3><p>Attention æœºåˆ¶å®é™…æ˜¯åœ¨æ¨¡ä»¿äººç±»é˜…è¯»å’Œå†™ä½œæ—¶çš„æ³¨æ„åŠ›, é‚£ä¹ˆäººéƒ½å¯ä»¥ä¸‰å¿ƒäºŒæ„, æœºå™¨ä¸ºä»€ä¹ˆä¸è¡Œ (</p><p><img src=/p/my-transformer/images/My%20Transformer-image-13.png width=1456 height=709 srcset="/p/my-transformer/images/My%20Transformer-image-13_hu_9541afb8de28e8d8.png 480w, /p/my-transformer/images/My%20Transformer-image-13_hu_4650762ff76e2469.png 1024w" loading=lazy alt=My-Transformer-image-13 class=gallery-image data-flex-grow=205 data-flex-basis=492px></p><p><img src=/p/my-transformer/images/My%20Transformer-image-14.png width=1189 height=625 srcset="/p/my-transformer/images/My%20Transformer-image-14_hu_9eb992b8c448ffb4.png 480w, /p/my-transformer/images/My%20Transformer-image-14_hu_86d4710e6ec004e.png 1024w" loading=lazy alt=My-Transformer-image-14 class=gallery-image data-flex-grow=190 data-flex-basis=456px></p><p>æ‰€ä»¥æˆ‘ä»¬æŠŠ embedding åˆ†æˆå¤šä»½, åˆ†åˆ«ç”¨å¤šä¸ªæ³¨æ„åŠ›å¤´å»å…³æ³¨æ•´ä¸ªå‘é‡</p><p><img src=/p/my-transformer/images/My%20Transformer-image-15.png width=1063 height=442 srcset="/p/my-transformer/images/My%20Transformer-image-15_hu_49ae9e10b62aacb9.png 480w, /p/my-transformer/images/My%20Transformer-image-15_hu_61db52740bcf90a.png 1024w" loading=lazy alt=My-Transformer-image-15 class=gallery-image data-flex-grow=240 data-flex-basis=577px></p><p>å®ç°:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>MultiHead</span><span class=p>(</span><span class=n>nn</span><span class=o>.</span><span class=n>Module</span><span class=p>):</span>
</span></span><span class=line><span class=cl>Â  Â  <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>()</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=bp>self</span><span class=o>.</span><span class=n>heads</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>ModuleList</span><span class=p>([</span><span class=n>Head</span><span class=p>()</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>head_num</span><span class=p>)])</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=bp>self</span><span class=o>.</span><span class=n>fc</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Linear</span><span class=p>(</span><span class=n>head_num</span> <span class=o>*</span> <span class=n>head_size</span><span class=p>,</span> <span class=n>embedding_dim</span><span class=p>)</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=bp>self</span><span class=o>.</span><span class=n>dropout</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Dropout</span><span class=p>(</span><span class=n>dropout_rate</span><span class=p>)</span>
</span></span><span class=line><span class=cl>Â  Â  <span class=k>def</span> <span class=nf>forward</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>x</span><span class=p>):</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=c1># x: (batch_size, block_size, embedding_dim)</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=c1># return: (batch_size, block_size, embedding_dim)</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=n>out</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fc</span><span class=p>(</span><span class=n>torch</span><span class=o>.</span><span class=n>cat</span><span class=p>([</span><span class=n>h</span><span class=p>(</span><span class=n>x</span><span class=p>)</span> <span class=k>for</span> <span class=n>h</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>heads</span><span class=p>],</span> <span class=n>dim</span><span class=o>=-</span><span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=n>out</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>dropout</span><span class=p>(</span><span class=n>out</span><span class=p>)</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=k>return</span> <span class=n>out</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=æ®‹å·®è¿æ¥>æ®‹å·®è¿æ¥</h3><p>å®è·µä¸­, åŠ å…¥æ®‹å·®è¿æ¥å’Œ Layer Norm æ•ˆæœä¼šæ›´å¥½</p><p><img src=/p/my-transformer/images/My%20Transformer-image-16.png width=1448 height=1087 srcset="/p/my-transformer/images/My%20Transformer-image-16_hu_f3168462dedc1dda.png 480w, /p/my-transformer/images/My%20Transformer-image-16_hu_8c7661ffb333db24.png 1024w" loading=lazy alt=My-Transformer-image-16 class=gallery-image data-flex-grow=133 data-flex-basis=319px></p><h4 id=residual-connection>Residual connection:</h4><p>ä¹Ÿå°±æ˜¯æŠŠè¾“å‡ºçš„ b å‘é‡åŠ ä¸Šè¾“å…¥çš„ a å‘é‡, ä¸€ä¸ªç†è§£æ˜¯æˆ‘ä»¬ QKV çŸ©é˜µå˜æ¢å®é™…ä¸Šè®¡ç®—å‡ºçš„å‘é‡, å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªè¯è¯­å‘é‡åœ¨ä¸Šä¸‹æ–‡ä¸­çš„åç§», è¦åŠ ä¸ŠåŸæœ¬çš„å‘é‡æ‰æ›´åŠ ç¨³å®š, ä¸ç®¡æ€ä¹ˆæ ·, ä»– works, å¯ä»¥ç¼“è§£æ¢¯åº¦æ¶ˆå¤±é—®é¢˜</p><h4 id=layer-norm>Layer Norm:</h4><p>åŒºåˆ†äº BatchNorm, BN æ˜¯å¯¹æ•´ä¸ª batch çš„åŒä¸€ä¸ª dimension çš„ feature è¿›è¡Œå½’ä¸€åŒ–, LN æ˜¯å¯¹åŒä¸€ä¸ªå‘é‡çš„ä¸åŒ dimension å½’ä¸€åŒ–</p><p>æˆ‘ä»¬ä¸ä»… self-attention çš„è¾“å‡ºè¦æ®‹å·®è¿æ¥å’Œå½’ä¸€åŒ–, è¾“å…¥è¿› FC çš„ä¹Ÿè¦è¿›è¡Œæ®‹å·®è¿æ¥å’Œå½’ä¸€åŒ–, äºæ˜¯ç›´æ¥æŠŠè¿™ä¸ªæ•´ä½“å°è£…æˆä¸€ä¸ª Block</p><h4 id=block>Block</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>Block</span><span class=p>(</span><span class=n>nn</span><span class=o>.</span><span class=n>Module</span><span class=p>):</span>
</span></span><span class=line><span class=cl>Â  Â  <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>()</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=bp>self</span><span class=o>.</span><span class=n>ln1</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>LayerNorm</span><span class=p>(</span><span class=n>embedding_dim</span><span class=p>)</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=bp>self</span><span class=o>.</span><span class=n>ln2</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>LayerNorm</span><span class=p>(</span><span class=n>embedding_dim</span><span class=p>)</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=bp>self</span><span class=o>.</span><span class=n>sa</span> <span class=o>=</span> <span class=n>MultiHead</span><span class=p>()</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=bp>self</span><span class=o>.</span><span class=n>ff</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Sequential</span><span class=p>(</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  Â  Â  <span class=n>nn</span><span class=o>.</span><span class=n>Linear</span><span class=p>(</span><span class=n>embedding_dim</span><span class=p>,</span> <span class=n>hidden_dim</span><span class=p>),</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  Â  Â  <span class=n>nn</span><span class=o>.</span><span class=n>ReLU</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  Â  Â  <span class=n>nn</span><span class=o>.</span><span class=n>Dropout</span><span class=p>(</span><span class=n>dropout_rate</span><span class=p>),</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  Â  Â  <span class=n>nn</span><span class=o>.</span><span class=n>Linear</span><span class=p>(</span><span class=n>hidden_dim</span><span class=p>,</span> <span class=n>embedding_dim</span><span class=p>),</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  Â  Â  <span class=n>nn</span><span class=o>.</span><span class=n>Dropout</span><span class=p>(</span><span class=n>dropout_rate</span><span class=p>)</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Â  Â  <span class=k>def</span> <span class=nf>forward</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>x</span><span class=p>):</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=c1># x: (batch_size, block_size, embedding_dim)</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=c1># return: (batch_size, block_size, embedding_dim)</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=n>out</span> <span class=o>=</span> <span class=n>x</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>sa</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>ln1</span><span class=p>(</span><span class=n>x</span><span class=p>))</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=n>out</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ln2</span><span class=p>(</span><span class=n>out</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>ff</span><span class=p>(</span><span class=n>out</span><span class=p>))</span>
</span></span><span class=line><span class=cl>Â  Â  Â  Â  <span class=k>return</span> <span class=n>out</span>
</span></span></code></pre></td></tr></table></div></div><p>å€¼å¾—ä¸€æçš„æ˜¯, è¿™é‡ŒåŸè®ºæ–‡æ˜¯å…ˆè¾“è¿›æ³¨æ„åŠ›å±‚, å† ln, å«åš post-ln, æœ‰è®ºæ–‡è¯´ pre-ln æ•ˆæœæ›´å¥½, æˆ‘ä¹Ÿé‡‡ç”¨äº† pre-ln, ä¸è¿‡æ„Ÿè§‰æ²¡å•¥æå‡, å¯èƒ½æ˜¯æˆ‘æ•°æ®å¤ªçƒ‚äº†, æ²¡æ€ä¹ˆåšæ¸…æ´—, è¿™ä¸æ˜¯é‡ç‚¹</p><h3 id=å¤šçº§æ®‹å·®ç½‘ç»œ>å¤šçº§æ®‹å·®ç½‘ç»œ</h3><p><img src=/p/my-transformer/images/My%20Transformer-image-17.png width=1390 height=552 srcset="/p/my-transformer/images/My%20Transformer-image-17_hu_8bc62412eda5174e.png 480w, /p/my-transformer/images/My%20Transformer-image-17_hu_c6d4988e403b212.png 1024w" loading=lazy alt=My-Transformer-image-17 class=gallery-image data-flex-grow=251 data-flex-basis=604px></p><p>ä¸ºäº†å¢åŠ æ¨¡å‹çš„å¤æ‚æ€§, æˆ‘ä»¬ä¼šè¿æ¥å¤šä¸ª block, å½¢æˆå¤æ‚çš„ç½‘ç»œ, åœ¨ pytorch ä¸­ä¹Ÿå¾ˆå¥½å®ç°è¿™ä¸€ç‚¹, äºæ˜¯æ¨¡å‹æœ€ç»ˆç‰ˆå®Œæˆäº†</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Model</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>LanguageModel</span><span class=p>(</span><span class=n>nn</span><span class=o>.</span><span class=n>Module</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>()</span>
</span></span><span class=line><span class=cl>     
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>vocab_embedding</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Embedding</span><span class=p>(</span><span class=n>vocab_size</span><span class=p>,</span> <span class=n>embedding_dim</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>position_embedding</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Embedding</span><span class=p>(</span><span class=n>block_size</span><span class=p>,</span> <span class=n>embedding_dim</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>blocks</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Sequential</span><span class=p>(</span><span class=o>*</span><span class=p>[</span><span class=n>Block</span><span class=p>()</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>num_blocks</span><span class=p>)])</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>dropout</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Dropout</span><span class=p>(</span><span class=mf>0.2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ln_f</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>LayerNorm</span><span class=p>(</span><span class=n>embedding_dim</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>fc</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Linear</span><span class=p>(</span><span class=n>embedding_dim</span><span class=p>,</span> <span class=n>vocab_size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=c1># x: (batch_size, block_size) å•ä½æ˜¯token</span>
</span></span><span class=line><span class=cl>    <span class=c1># target: (batch_size, block_size) å•ä½æ˜¯token</span>
</span></span><span class=line><span class=cl>    <span class=c1># è¿”å›: (batch_size, block_size, vocab_size) logits</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>forward</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>target</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>B</span><span class=p>,</span> <span class=n>T</span> <span class=o>=</span> <span class=n>x</span><span class=o>.</span><span class=n>shape</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>ve</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>vocab_embedding</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>pe</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>position_embedding</span><span class=p>(</span><span class=n>torch</span><span class=o>.</span><span class=n>arange</span><span class=p>(</span><span class=n>T</span><span class=p>)</span><span class=o>.</span><span class=n>to</span><span class=p>(</span><span class=n>device</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=n>ve</span> <span class=o>+</span> <span class=n>pe</span> <span class=c1># (B, T, E)</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>blocks</span><span class=p>(</span><span class=n>h</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ln_f</span><span class=p>(</span><span class=n>h</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>logits</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fc</span><span class=p>(</span><span class=n>h</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># è®¡ç®—loss</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>target</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>loss</span> <span class=o>=</span> <span class=n>F</span><span class=o>.</span><span class=n>cross_entropy</span><span class=p>(</span><span class=n>logits</span><span class=o>.</span><span class=n>view</span><span class=p>(</span><span class=n>B</span><span class=o>*</span><span class=n>T</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>),</span> <span class=n>target</span><span class=o>.</span><span class=n>view</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>loss</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>logits</span><span class=p>,</span> <span class=n>loss</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># ç”Ÿæˆ</span>
</span></span><span class=line><span class=cl>    <span class=c1># token_seq: (batch_size, block_size) ä¸Šæ–‡, å•ä½æ˜¯token</span>
</span></span><span class=line><span class=cl>    <span class=c1># max_token: int æœ€å¤§ç”Ÿæˆé•¿åº¦</span>
</span></span><span class=line><span class=cl>    <span class=c1># è¿”å›: (batch_size, max_token) ç”Ÿæˆçš„tokenåºåˆ—</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>generate</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>token_seq</span><span class=p>,</span> <span class=n>max_token</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>max_token</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=c1># å–æœ€åblock_sizeä¸ªtoken</span>
</span></span><span class=line><span class=cl>            <span class=n>token_input</span> <span class=o>=</span> <span class=n>token_seq</span><span class=p>[:,</span> <span class=o>-</span><span class=n>block_size</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>            <span class=c1># è®¡ç®—logits</span>
</span></span><span class=line><span class=cl>            <span class=n>logits</span><span class=p>,</span> <span class=n>loss</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>forward</span><span class=p>(</span><span class=n>token_input</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># å–å­—ç¬¦ä¸²çš„æœ€åä¸€ä¸ªå­—ç¬¦, ç›®å‰è¿˜åªæ˜¯ç½‘ç»œç›´æ¥è¾“å‡ºçš„ç»“æœ</span>
</span></span><span class=line><span class=cl>            <span class=n>logits</span> <span class=o>=</span> <span class=n>logits</span><span class=p>[:,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=p>:]</span>
</span></span><span class=line><span class=cl>            <span class=c1># softmax,ç»´åº¦æ˜¯-1,ä¹Ÿå°±æ˜¯vocabularyçš„ç»´åº¦</span>
</span></span><span class=line><span class=cl>            <span class=n>prob</span> <span class=o>=</span> <span class=n>F</span><span class=o>.</span><span class=n>softmax</span><span class=p>(</span><span class=n>logits</span><span class=p>,</span> <span class=n>dim</span><span class=o>=-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># é‡‡æ ·, è¾“å‡ºæ˜¯ä¸‹ä¸€ä¸ªtoken,å½¢çŠ¶æ˜¯(batch_size, 1)</span>
</span></span><span class=line><span class=cl>            <span class=n>next_token</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>multinomial</span><span class=p>(</span><span class=n>prob</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># æ‹¼æ¥åˆ°token_seqåé¢, åœ¨æ—¶é—´ç»´åº¦ä¸Š</span>
</span></span><span class=line><span class=cl>            <span class=n>token_seq</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>cat</span><span class=p>([</span><span class=n>token_seq</span><span class=p>,</span> <span class=n>next_token</span><span class=p>],</span> <span class=n>dim</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>token_seq</span><span class=p>[:,</span> <span class=o>-</span><span class=n>max_token</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@torch.no_grad</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>estimate</span><span class=p>(</span><span class=n>model</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>splits</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;train&#34;</span><span class=p>,</span> <span class=s2>&#34;valid&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>.</span><span class=n>eval</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>out</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>split</span> <span class=ow>in</span> <span class=n>splits</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>losses</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=n>num_interval</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>num_interval</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>x</span><span class=p>,</span> <span class=n>y</span> <span class=o>=</span> <span class=n>get_batch</span><span class=p>(</span><span class=n>split</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>logits</span><span class=p>,</span> <span class=n>loss</span> <span class=o>=</span> <span class=n>model</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>losses</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>loss</span><span class=o>.</span><span class=n>item</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>out</span><span class=p>[</span><span class=n>split</span><span class=p>]</span> <span class=o>=</span> <span class=n>losses</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>.</span><span class=n>train</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>out</span>                
</span></span></code></pre></td></tr></table></div></div><h2 id=å¤ç›˜>å¤ç›˜</h2><h3 id=æˆæœ>æˆæœ</h3><p>ç”¨ä¸€äº›åè‘—è®­ç»ƒçœ‹çœ‹æ•ˆæœå§, é¦–å…ˆè°ƒæ•´ä¸€ä¸‹è¶…å‚æ•°</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Hyperparameters</span>
</span></span><span class=line><span class=cl><span class=n>random_seed</span> <span class=o>=</span> <span class=mi>3221</span>
</span></span><span class=line><span class=cl><span class=n>torch</span><span class=o>.</span><span class=n>manual_seed</span><span class=p>(</span><span class=n>random_seed</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>batch_size</span> <span class=o>=</span> <span class=mi>128</span>
</span></span><span class=line><span class=cl><span class=n>block_size</span> <span class=o>=</span> <span class=mi>256</span>
</span></span><span class=line><span class=cl><span class=n>num_blocks</span> <span class=o>=</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl><span class=n>head_num</span> <span class=o>=</span> <span class=mi>12</span>
</span></span><span class=line><span class=cl><span class=n>embedding_dim</span> <span class=o>=</span> <span class=mi>192</span>
</span></span><span class=line><span class=cl><span class=n>validation_split</span> <span class=o>=</span> <span class=mf>0.2</span>
</span></span><span class=line><span class=cl><span class=n>device</span> <span class=o>=</span> <span class=s2>&#34;cuda&#34;</span> <span class=k>if</span> <span class=n>torch</span><span class=o>.</span><span class=n>cuda</span><span class=o>.</span><span class=n>is_available</span><span class=p>()</span> <span class=k>else</span> <span class=s2>&#34;cpu&#34;</span>
</span></span><span class=line><span class=cl><span class=n>wrapped_width</span> <span class=o>=</span> <span class=mi>50</span>
</span></span><span class=line><span class=cl><span class=n>hidden_dim</span> <span class=o>=</span> <span class=mi>768</span>
</span></span><span class=line><span class=cl><span class=n>num_epochs</span> <span class=o>=</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl><span class=n>learning_rate</span> <span class=o>=</span> <span class=mi>5</span><span class=n>e</span><span class=o>-</span>
</span></span><span class=line><span class=cl><span class=n>weight_decay</span> <span class=o>=</span> <span class=mf>0.06</span>
</span></span><span class=line><span class=cl><span class=n>patience</span> <span class=o>=</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl><span class=n>dropout_rate</span> <span class=o>=</span> <span class=mf>0.1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>num_interval</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=n>num_epochs</span> <span class=o>//</span> <span class=mi>10</span><span class=p>,</span> <span class=mi>50</span><span class=p>)</span> Â <span class=c1># æ¯5%çš„epochsæˆ–è‡³å°‘æ¯10ä¸ªepochséªŒè¯ä¸€æ¬¡</span>
</span></span><span class=line><span class=cl><span class=n>head_size</span> <span class=o>=</span> <span class=n>embedding_dim</span> <span class=o>//</span> <span class=n>head_num</span>
</span></span></code></pre></td></tr></table></div></div><p>è®­ç»ƒè¿‡ç¨‹è€—æ—¶ 11m 21.8s</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>Epoch 0, Loss: 8.412135124206543 
</span></span><span class=line><span class=cl>Train Loss: 8.115385055541992 
</span></span><span class=line><span class=cl>Valid Loss: 8.124889373779297 
</span></span><span class=line><span class=cl>-------------------------------------------------- 
</span></span><span class=line><span class=cl>Epoch 100, Loss: 5.311680793762207 
</span></span><span class=line><span class=cl>Train Loss: 5.232851982116699 
</span></span><span class=line><span class=cl>Valid Loss: 5.768039703369141 
</span></span><span class=line><span class=cl>-------------------------------------------------- 
</span></span><span class=line><span class=cl>Epoch 200, Loss: 4.538897514343262 
</span></span><span class=line><span class=cl>Train Loss: 4.509884357452393 
</span></span><span class=line><span class=cl>Valid Loss: 5.323651313781738 
</span></span><span class=line><span class=cl>-------------------------------------------------- 
</span></span><span class=line><span class=cl>Epoch 300, Loss: 4.282341480255127 
</span></span><span class=line><span class=cl>Train Loss: 4.204404354095459 
</span></span><span class=line><span class=cl>Valid Loss: 5.213500499725342 
</span></span><span class=line><span class=cl>-------------------------------------------------- 
</span></span><span class=line><span class=cl>Epoch 400, Loss: 4.078436851501465 
</span></span><span class=line><span class=cl>Train Loss: 4.0135650634765625 
</span></span><span class=line><span class=cl>Valid Loss: 5.163753032684326 
</span></span><span class=line><span class=cl>-------------------------------------------------- 
</span></span><span class=line><span class=cl>Epoch 500, Loss: 3.9056577682495117 
</span></span><span class=line><span class=cl>Train Loss: 3.8425979614257812 
</span></span><span class=line><span class=cl>Valid Loss: 5.133504867553711 
</span></span><span class=line><span class=cl>-------------------------------------------------- 
</span></span><span class=line><span class=cl>Epoch 600, Loss: 3.766578435897827 
</span></span><span class=line><span class=cl>Train Loss: 3.689257860183716 
</span></span><span class=line><span class=cl>Valid Loss: 5.1122727394104 
</span></span><span class=line><span class=cl>-------------------------------------------------- 
</span></span><span class=line><span class=cl>Epoch 700, Loss: 3.659522294998169 
</span></span><span class=line><span class=cl>Train Loss: 3.543461799621582 
</span></span><span class=line><span class=cl>Valid Loss: 5.107848644256592 
</span></span><span class=line><span class=cl>-------------------------------------------------- 
</span></span><span class=line><span class=cl>Epoch 800, Loss: 3.543654203414917 
</span></span><span class=line><span class=cl>Train Loss: 3.4007351398468018 
</span></span><span class=line><span class=cl>Valid Loss: 5.122027397155762 
</span></span><span class=line><span class=cl>-------------------------------------------------- 
</span></span><span class=line><span class=cl>Early stopping!
</span></span></code></pre></td></tr></table></div></div><p>ç”Ÿæˆç‚¹æ–‡å­—çœ‹çœ‹:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>--------------------------------------------------
</span></span><span class=line><span class=cl>ä¸Šæ–‡:
</span></span><span class=line><span class=cl>ä½™ã€‚  åŒæ—¶ï¼Œæ€»çš„ç”Ÿäº§è§„æ¨¡ä¹‹æ‰©å¤§ï¼Œå½“ç„¶å¢åŠ é‚£ç§ä¸æ˜¯ç›´æ¥æœ‰èµ–äºä¸ªåˆ«ä¼ä¸šå¤§å°çš„ç»æµã€‚è¿™äº›ç»æµä¸­æœ€é‡è¦çš„ï¼Œæ˜¯ç”±äºç›¸å…³çš„å·¥ä¸šéƒ¨é—¨çš„å‘è¾¾è€Œäº§ç”Ÿçš„ï¼Œè¿™äº›éƒ¨é—¨äº’ç›¸å¸®åŠ©ï¼Œä¹Ÿè®¸é›†
</span></span><span class=line><span class=cl>ä¸­åœ¨åŒä¸€åœ°æ–¹ï¼Œä½†æ— è®ºå¦‚ä½•ï¼Œå®ƒä»¬éƒ½åˆ©ç”¨è½®èˆ¹ã€ç«è½¦ã€ç”µæŠ¥ã€å°åˆ·æœºç­‰æ‰€æä¾›çš„è¿‘ä»£äº¤é€šä¾¿åˆ©ã€‚åƒè¿™ç§æ¥æºæ‰€äº§ç”Ÿçš„å„ç§ç»æµï¼Œæ˜¯ä»»ä½•ç”Ÿäº§éƒ¨é—¨éƒ½å¯è·å¾—çš„ï¼Œè€Œä¸æ˜¯å®Œå…¨ä¾é å®ƒè‡ªå·±çš„
</span></span><span class=line><span class=cl>å‘è¾¾ï¼šä½†æ˜¯ï¼Œè¿™äº›ç»æµå¿…ç„¶æ˜¯éšç€å®ƒè‡ªå·±çš„å‘è¾¾è€Œè¿…é€Ÿåœ°å’Œç¨³æ­¥åœ°å¢å¤§ï¼›å¦‚æœå®ƒè¡°è´¥çš„è¯ï¼Œè¿™äº›ç»æµåœ¨æŸäº›æ–¹é¢â€”â€”  è™½ç„¶ä¸æ˜¯åœ¨ä¸€åˆ‡æ–¹é¢â€”â€”å¿…ç„¶æ˜¯ç¼©å°çš„ã€‚
</span></span><span class=line><span class=cl>ç¬¬äºŒèŠ‚ã€€ç”Ÿäº§è´¹ç”¨åº”å½“ä»¥ä¸€ä¸ªä»£è¡¨æ€§ä¼ä¸šæ¥è¯´æ˜ï¼Œè¿™
</span></span><span class=line><span class=cl>--------------------------------------------------
</span></span><span class=line><span class=cl>çœŸå®ä¸‹æ–‡:
</span></span><span class=line><span class=cl>ä¸ªä¼ä¸šèƒ½æ­£å¸¸åœ°è·å¾—å±äºä¸€å®šçš„æ€»ç”Ÿäº§é‡çš„å†…éƒ¨ç»æµä¸å¤–éƒ¨ç»æµã€‚æŠ¥é…¬ä¸å˜ä¸æŠ¥é…¬é€’å¢ã€‚  å½“æˆ‘ä»¬ç ”ç©¶æ”¯é…ä¸€ç§å•†å“çš„ä¾›ç»™ä»·æ ¼ä¹‹å„ç§åŸå› æ—¶ï¼Œè¿™äº›ç»“æœå…·æœ‰å¾ˆå¤§çš„é‡è¦æ€§ã€‚æˆ‘ä»¬å¿…
</span></span><span class=line><span class=cl>é¡»ä»”ç»†åˆ†æç”Ÿäº§ä¸€ç§å•†å“ä¸ä¸€å®šçš„æ€»ç”Ÿäº§é‡æœ‰å…³çš„æ­£å¸¸è´¹ç”¨ï¼›ä¸ºäº†è¿™ä¸ªç›®çš„ï¼Œæˆ‘ä»¬å°†è¦ç ”ç©¶åœ¨é‚£ä¸ªæ€»ç”Ÿäº§é‡ä¹‹ä¸‹ä¸€ä¸ªä»£è¡¨æ€§ç”Ÿäº§è€…çš„è´¹ç”¨ã€‚ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬ä¸è¦é€‰æ‹©æŸä¸€åˆšåˆšç«­åŠ›æŠ•èº«è¥
</span></span><span class=line><span class=cl>ä¸šçš„æ–°ç”Ÿäº§è€…ä¸ºä»£è¡¨ï¼Œä»–åœ¨è®¸å¤šä¸åˆ©çš„æ¡ä»¶ä¸‹ç»è¥ï¼Œä¸€æ—¶ä¸å¾—ä¸æ»¡è¶³äºå¾ˆå°‘çš„åˆ©æ¶¦æˆ–æ²¡æœ‰åˆ©æ¶¦ï¼Œä½†ä»–å¯¹ä»¥ä¸‹çš„äº‹å®æ˜¯æ»¡æ„çš„ï¼›ä»–æ­£åœ¨å»ºç«‹è¥ä¸šå…³ç³»ï¼Œå¯¹äºå»ºç«‹æˆåŠŸçš„è¥ä¸šæ­£æœ‰å¤´ç»ªï¼›å¦
</span></span><span class=line><span class=cl>ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬ä¹Ÿä¸è¦é‡‡å–è¿™æ ·ä¸€ä¸ªä¼ä¸šä¸ºä»£è¡¨ï¼šç”±äºéå¸¸æŒä¹…çš„èƒ½åŠ›å’Œå¥½è¿æ°”ï¼Œå®ƒå·²ç»æœ‰äº†å¾ˆå¤§çš„è¥ä¸šå’Œäº•äº•æœ‰æ¡çš„å¤§å·¥åœºï¼Œè€Œè¿™äº›å¤§å·¥
</span></span><span class=line><span class=cl>--------------------------------------------------
</span></span><span class=line><span class=cl>ç”Ÿæˆä¸‹æ–‡:
</span></span><span class=line><span class=cl>äº›å‚ä¸å¤‡æœ‰æ”¶å…¥å’Œå…¬å¸æœºçš„å…³ç³»ã€‚é›·ç›Šä¼¼å­˜åœ¨æ·±è®¤ä¸ºï¼Œæˆ‘ä»˜ä¸è¦å¤§å¤šç”¨è¿™ä¸€ä¸ªæ–°åŠ ä¸Šå‡çš„ç»æµä¿¡æ¯ï¼Œå®ƒå¯ä»¥å…ˆè¡°é€€å‡ºäºä»–ä»¬æ‰€ä½œç”¨åŠ å°±é€‚äº†æ­¤ï¼Œé™„é«˜çš„ä¾‹å¤–é‡Œå­¦ä¹ çš„æ—¶å°±æ˜¯å› ç´ è§£å®ƒã€‚
</span></span><span class=line><span class=cl>æˆ‘çš„è¡Œä¸ºä½¿ç”¨äºå­¦è¯´ï¼šæ— èƒ½æ”¯ä»˜çš„ç ”ç©¶åˆ«äººåœ°è€…å’Œé“¶åˆ°è¿™å®¶æ„¿æ„è¯†è‰¯å¥½å·¥ä¸šï¼Œè·å¾—å°†ä¼šåœ¨å› éè¥é”€åæ‚”çš„æŠ€èƒ½æ€§ç»„ç»‡ã€ä¸åŒçš„å†’é™©çš„ä¸€ç§ï¼Œçœ‹å¾…ç€è¾ƒæœ‰è‰¯å¥½ï¼Œå½“åœ°å·¥ä½œæ›´å¤šçš„é™ˆäº§ä¹Ÿä¹Ÿ
</span></span><span class=line><span class=cl>å°±äº§é¡¹ç›®å¸Œæœ›è´¢å¯Œä¸ºæ˜¯å·¥å‘˜ã€‚çœŸæ­£è¶Šå¤šçš„å’ŒåŒæ ·çš„æ¯ä¸€ç§æƒ…ä¹ è¿™ç§æˆä¸ºï¼Œè€Œæ˜¯ä¸–ç•Œä¸Šå—è¿‡çš„ç”Ÿçš„å¿ƒç†è§£å®ƒçš„æœºä¼šï¼Œç»çºªäººå°±å¢åŠ äº†ã€‚æ­£å¼å’Œæ”¿åºœçš„â€œåï¼Œä½ æƒ³å°†æ¥çœ‹æ‰¿è™šæ‹Ÿæ—¶é—´çš„æ¢¦æƒ³
</span></span><span class=line><span class=cl>å¿˜é•œå­ã€‚â€è¶…è¿‡å»åœ¨å¤ªå¯Œäº†è´«ç©·äººä¸å˜åŒ–ï¼Œè¿˜åˆ°10ç¾å…ƒçš„â€œå˜æˆè™šæ‹Ÿè½»æ¾å·¥ä½œâ€ä¸­ï¼Œè€Œè‡ªå·±ä¹Ÿæ˜¯ç„¶å¯»æ³•å¾‹çš„è¿™ä¸€ä¸ªäººæ‰€ç»„æˆäº†ï¼Œä½†ç°æ¶
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹å‡ºæ¥æ•ˆæœè¿˜æ˜¯ä¸é”™çš„, è™½ç„¶æ²¡ä»€ä¹ˆè¯­ä¹‰, ä½†æ˜¯æ ‡ç‚¹ç¬¦å·åŸºæœ¬éƒ½èƒ½å¯¹ä¸Š, çœ‹ç€ä¹Ÿåƒä¸ªå¥å­, å—¯, å¾ˆæ»¡æ„</p><h3 id=é—®é¢˜åˆ†æ>é—®é¢˜åˆ†æ</h3><ul><li>å¯ä»¥çœ‹åˆ°è®­ç»ƒè¿‡ç¨‹ä¸­å‡ºç°äº†æ˜æ˜¾çš„è¿‡æ‹Ÿåˆé—®é¢˜, åº”è¯¥ä¸»è¦æ˜¯æ•°æ®ä¸è¶³çš„é—®é¢˜</li><li>è®­ç»ƒè¿‡ç¨‹ä¸­, éªŒè¯é›†çš„ loss è®¡ç®—çš„å¾ˆæ…¢, è·Ÿè®­ç»ƒçš„æ—¶é—´éƒ½å·®ä¸å¤šäº†, è¿™ä¸ªåç»­å¯ä»¥ä¼˜åŒ–ä¸€ä¸‹</li><li>è¶…å‚æ•°å’Œæ¨¡å‹æ²¡æœ‰å¤ªå¤šä¼˜åŒ–, å› ä¸ºæ¨¡å‹è®­ç»ƒå¤ªæ…¢äº†, æˆ‘ä¹Ÿæ‡’å¾—ç­‰&mldr;</li></ul><h3 id=æ€»ç»“>æ€»ç»“</h3><p>å¾ˆå¥½ç©çš„ä¸€æ¬¡å®è·µ, ä¹‹å‰ä¸€ç›´å¯¹ pytorch é‡Œå¼ é‡çš„ç»´æ•°æœ‰ç‚¹æ™•, å®æ“ä¸€æ¬¡ä¸‹æ¥å°±æ¯”è¾ƒæ¸…æ™°äº†, å¯¹ transformer çš„è®¤è¯†ä¹Ÿæ›´åŠ æ¸…æ™°äº†, éå¸¸æ„Ÿè°¢ b ç«™ up <a class=link href=https://space.bilibili.com/1570063857 target=_blank rel=noopener>é»¯æ·¡è“ç‚¹çš„å±…æ°‘</a>çš„è§†é¢‘å’Œ NTU æå®æ¯…è€å¸ˆçš„æœºå™¨å­¦ä¹ è¯¾ç¨‹</p></section><footer class=article-footer><section class=article-tags><a href=/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/>æ·±åº¦å­¦ä¹ </a>
<a href=/tags/transformer/>Transformer</a>
<a href=/tags/self-attention/>Self-Attention</a>
<a href=/tags/ai/>AI</a>
<a href=/tags/pytorch/>Pytorch</a></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector(".main-article");renderMathInElement(e,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],ignoredClasses:["gist"]})})</script></article><aside class=related-content--wrapper><h2 class=section-title>ç›¸å…³æ–‡ç« </h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/bayesian-ai/><div class=article-details><h2 class=article-title>Bayesian Ai</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2025 Toki çš„ä¸ªäººåšå®¢</section><section class=powerby>ä½¿ç”¨ <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> æ„å»º<br>ä¸»é¢˜ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> ç”± <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> è®¾è®¡</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>